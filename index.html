
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra Cứu Vị Trí Sản Phẩm</title>
    <style>
      :root {
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
        color: #111111;
        background-color: #f4f4f4;
        line-height: 1.5;
        --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      }

      * {
        box-sizing: border-box;
      }

      [hidden] {
        display: none !important;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: clamp(1.25rem, 4vw, 3rem);
        background-color: #f2f2f2;
        overflow-y: scroll; /* Giữ thanh cuộn để tránh layout shift */
        position: relative;
        isolation: isolate;
      }

      body::before {
        content: "";
        position: fixed;
        inset: -25%;
        z-index: -1;
        pointer-events: none;
        background:
          radial-gradient(circle at 18% 22%, rgba(0, 0, 0, 0.09), transparent 42%),
          radial-gradient(circle at 78% 28%, rgba(0, 0, 0, 0.06), transparent 44%),
          radial-gradient(circle at 52% 82%, rgba(0, 0, 0, 0.05), transparent 50%);
        filter: blur(22px);
        transform: translate3d(0, 0, 0);
        animation: ambientFloat 10s var(--ease-out-expo) infinite alternate;
      }

      main {
        width: min(1200px, 100%);
        background: #ffffff;
        border-radius: 40px;
        padding: clamp(1.5rem, 4vw, 3rem);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        animation: fadeInMain 0.8s var(--ease-out-expo);
      }

      header {
        margin-bottom: 2rem;
        text-align: center;
      }

      header h1 {
        margin: 0 0 0.4rem;
        font-size: clamp(2.5rem, 6vw, 4rem);
        font-weight: 800;
        letter-spacing: -0.03em;
      }

      header p {
        margin: 0.3rem 0 0;
        color: #666;
      }

      .lookup-form {
        display: flex;
        align-items: center;
        flex-wrap: nowrap;
        gap: 0.75rem;
        margin: 0 auto 1.25rem;
        max-width: 460px;
        width: 100%;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.35rem;
        color: #666;
      }

      input[type="text"] {
        flex: 1 1 auto;
        min-width: 0;
        border-radius: 100px;
        border: 1px solid #e5e5e5;
        background: #f9f9f9;
        padding: 0.95rem 1.15rem;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input[type="text"]::placeholder {
        font-weight: 500;
        letter-spacing: normal;
      }

      input[type="text"]:focus {
        border-color: #000;
        background: #fff;
        box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
        outline: none;
      }

      button {
        border: none;
        border-radius: 100px;
        padding: 0.95rem 1.4rem;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        white-space: nowrap;
      }

      button[type="submit"] {
        background: #000;
        color: white;
        box-shadow: none;
        padding-inline: clamp(1.2rem, 4vw, 2.4rem);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      button:not(:disabled):active {
        transform: translateY(0);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
      }

      button[type="submit"].loading {
        color: transparent;
        position: relative;
      }

      button[type="submit"].loading::after {
        content: "";
        position: absolute;
        width: 1.2em;
        height: 1.2em;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: auto;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      .status-bar {
        border-radius: 100px;
        padding: 0.9rem 1.15rem;
        font-size: 0.96rem;
        font-weight: 600;
        display: flex;
        gap: 0.6rem;
        align-items: center;
        margin: 0 auto 1.5rem;
        max-width: 520px;
        width: 100%;
        animation: slideDown 0.4s var(--ease-out-expo);
      }

      .status-bar[data-variant="idle"] {
        background: #f9f9f9;
        color: #666;
      }

      .status-bar[data-variant="loading"] {
        background: #f0f0f0;
        color: #000;
      }

      .status-bar[data-variant="success"] {
        background: #f0fdf4;
        color: #15803d;
      }

      .status-bar[data-variant="empty"] {
        background: #fffbeb;
        color: #b45309;
      }

      .status-bar[data-variant="error"] {
        background: #fef2f2;
        color: #b91c1c;
      }

      .top-progress {
        max-width: 520px;
        width: 100%;
        height: 10px;
        margin: 0.25rem auto 1.25rem;
        border-radius: 999px;
        background: #f0f0f0;
        overflow: hidden;
        position: relative;
        animation: fadeInUp 0.35s var(--ease-out-expo);
      }

      .top-progress .bar {
        position: absolute;
        inset: 0;
        width: 45%;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.18) 35%,
          rgba(0, 0, 0, 0.32) 50%,
          rgba(0, 0, 0, 0.18) 65%,
          rgba(0, 0, 0, 0) 100%
        );
        animation: progressIndeterminate 0.9s linear infinite;
        filter: blur(0.2px);
      }

      .result-card {
        display: grid;
        gap: 1.5rem;
        max-width: 980px;
        margin: 0 auto;
        width: 100%;
      }

      .product-card {
        background: #fff;
        border-radius: 32px;
        border: 1px solid #f0f0f0;
        padding: 0;
        overflow: hidden;
        position: relative;
        isolation: isolate;
      }

      .product-card::after {
        display: none;
      }

      .product-visual {
        width: 100%;
        height: 100%;
        aspect-ratio: 3 / 4;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f7f7f7;
      }

      .product-visual img,
      .product-visual .placeholder {
        width: 100%;
        height: 100%;
        border-radius: inherit;
      }

      .product-visual img {
        object-fit: contain;
        background: #f7f7f7;
      }

      .product-visual .placeholder {
        background: #f7f7f7;
        display: grid;
        place-items: center;
        color: #ccc;
        font-weight: 600;
        letter-spacing: 0.2em;
        position: relative;
        overflow: hidden;
      }

      /* Hiệu ứng Skeleton Loading khi chưa có ảnh */
      .product-visual .placeholder::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        animation: shimmer 1.5s infinite;
      }

      .location-panel {
        border-radius: 32px;
        border: 1px solid #f0f0f0;
        background: #fff;
        padding: 1.35rem;
        box-shadow: none;
      }

      .skeleton-block {
        height: 1rem;
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.06),
          rgba(0, 0, 0, 0.10),
          rgba(0, 0, 0, 0.06)
        );
        background-size: 220% 100%;
        animation: skeletonMove 1.1s ease-in-out infinite;
      }

      .skeleton-block.thin {
        height: 0.7rem;
      }

      .skeleton-block.w-40 { width: 40%; }
      .skeleton-block.w-70 { width: 70%; }

      .location-skeleton {
        display: grid;
        gap: 0.6rem;
        margin-top: 0.2rem;
      }

      .location-panel-header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.85rem;
        flex-wrap: nowrap;
      }

      .location-panel-header > div {
        flex: 1 1 auto;
        min-width: 0;
      }

      .location-panel-header .ghost-btn {
        margin-left: auto;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      .location-label {
        text-transform: uppercase;
        letter-spacing: 0.26em;
        font-size: 0.73rem;
        color: #999;
        font-weight: 600;
        margin-bottom: 0.3rem;
      }

      .location-text {
        margin: 0;
        font-size: 1.05rem;
        color: #000;
        font-weight: 600;
      }

      .ghost-btn {
        background: transparent;
        border: 1px solid #e5e5e5;
        color: #000;
        padding-inline: 1.2rem;
        font-size: 0.95rem;
      }

      .primary-btn {
        background: #000;
        color: white;
        box-shadow: none;
      }

      .neutral-btn {
        background: #fff;
        border: 1px solid #e5e5e5;
        color: #000;
        padding-inline: 1.1rem;
      }

      .ghost-btn:disabled,
      .neutral-btn:disabled,
      .primary-btn:disabled {
        opacity: 0.6;
        box-shadow: none;
      }

      .location-editor {
        margin-top: 0.85rem;
        padding: 1rem;
        border-radius: 24px;
        border: 1px solid #f0f0f0;
        background: white;
      }

      .location-editor textarea {
        width: 100%;
        min-height: 90px;
        border-radius: 16px;
        border: 1px solid #e5e5e5;
        background: #f9f9f9;
        color: #000;
        font-family: inherit;
        padding: 0.85rem 1rem;
        resize: vertical;
      }

      .location-editor textarea:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }

      .location-actions {
        margin-top: 0.8rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      footer {
        margin-top: 2.5rem;
        text-align: center;
        color: #94a3b8;
        font-size: 0.9rem;
      }

      /* --- ANIMATIONS --- */
      @keyframes fadeInMain {
        from { opacity: 0; transform: scale(0.98) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
      }

      @keyframes ambientFloat {
        0% { transform: translate3d(-2%, -1%, 0) rotate(-1deg); }
        100% { transform: translate3d(2%, 1%, 0) rotate(1deg); }
      }

      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); height: 0; padding-block: 0; margin-bottom: 0; }
        to { opacity: 1; transform: translateY(0); height: auto; } /* height auto ko animate mượt bằng JS nhưng đủ dùng cho visual */
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      @keyframes skeletonMove {
        0% { background-position: 0% 50%; }
        100% { background-position: 100% 50%; }
      }

      @keyframes progressIndeterminate {
        0% { transform: translateX(-120%); }
        100% { transform: translateX(260%); }
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Staggered Animation cho kết quả: Các thẻ hiện lần lượt */
      .result-card:not([hidden]) .location-panel {
        animation: fadeInUp 0.6s var(--ease-out-expo) 0s backwards;
      }
      .result-card:not([hidden]) .product-card {
        animation: fadeInUp 0.6s var(--ease-out-expo) 0.1s backwards;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
          scroll-behavior: auto !important;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        main {
          padding: clamp(1rem, 4vw, 1.75rem);
          border-radius: 22px;
        }

        .status-bar {
          font-size: 0.9rem;
          padding: 0.8rem 1rem;
        }

        .product-card {
          grid-template-columns: 1fr;
          padding: 1.25rem;
          gap: 1rem;
        }

        .product-visual {
          max-width: 380px;
          margin: 0 auto;
        }

        .product-details h2 {
          font-size: clamp(1.5rem, 6vw, 2rem);
        }

        .location-panel-header {
          gap: 0.75rem;
        }
        .ghost-btn {
          padding-inline: 1rem;
          font-size: 0.9rem;
        }

        .location-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .location-actions button {
          width: 100%;
        }

        .product-meta {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        footer {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 520px) {
        .lookup-form {
          gap: 0.5rem;
        }

        button[type="submit"] {
          width: auto;
          padding-inline: 1.25rem;
          font-size: 0.95rem;
        }

        input[type="text"] {
          padding: 0.85rem 1rem;
          font-size: 0.95rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Tra cứu vị trí sản phẩm</h1>
      </header>

      <form id="lookup-form" class="lookup-form" autocomplete="off">
        <label class="sr-only" for="sku-input">Mã sản phẩm</label>
        <input
          id="sku-input"
          type="text"
          name="sku"
          placeholder="VD: A324"
          maxlength="20"
          autocomplete="off"
          required
        />
        <button type="submit" id="lookup-button">Tra cứu</button>
      </form>

      <div class="status-bar" id="status-bar" data-variant="idle" hidden></div>
      <div class="top-progress" id="top-progress" hidden aria-hidden="true">
        <span class="bar"></span>
      </div>

      <section id="result-section" class="result-card" hidden>
        <article class="location-panel" id="location-panel" hidden>
          <div class="location-panel-header">
            <div>
              <p class="location-label">Vị trí sản phẩm</p>
              <div class="location-skeleton" id="location-skeleton" hidden>
                <div class="skeleton-block thin w-40"></div>
                <div class="skeleton-block w-70"></div>
              </div>
              <p id="product-location" class="location-text">
                Đang tải thông tin vị trí...
              </p>
            </div>
            <button type="button" class="ghost-btn" id="edit-location" hidden>
              Chỉnh sửa
            </button>
          </div>
          <div id="location-editor" class="location-editor" hidden>
            <textarea
              id="location-input"
              placeholder="Nhập vị trí mới..."
              maxlength="120"
            ></textarea>
            <div class="location-actions">
              <button type="button" class="neutral-btn" id="cancel-location">
                Hủy
              </button>
              <button type="button" class="primary-btn" id="save-location">
                Lưu vị trí
              </button>
            </div>
          </div>
        </article>

        <article class="product-card">
          <div class="product-visual" id="product-visual">
            <div class="placeholder">NO IMAGE</div>
          </div>
        </article>
      </section>

      <footer>&copy; <span id="year-label"></span> Kho vận hành.</footer>
    </main>

    <script>
      const API_URL =
        "https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/location_sanpham";
      const UPDATE_LOCATION_URL =
        "https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/nhaplai-location";
      const REQUEST_TIMEOUT = 12000;
      const STATUS_AUTO_HIDE = 2600;

      const form = document.getElementById("lookup-form");
      const input = document.getElementById("sku-input");
      const button = document.getElementById("lookup-button");
      const statusBar = document.getElementById("status-bar");
      const topProgress = document.getElementById("top-progress");
      const resultSection = document.getElementById("result-section");
      const locationPanel = document.getElementById("location-panel");
      const locationSkeleton = document.getElementById("location-skeleton");
      const productLocationEl = document.getElementById("product-location");
      const productVisualEl = document.getElementById("product-visual");
      const productCard = document.querySelector(".product-card");
      const editLocationBtn = document.getElementById("edit-location");
      const locationEditor = document.getElementById("location-editor");
      const locationInput = document.getElementById("location-input");
      const saveLocationBtn = document.getElementById("save-location");
      const cancelLocationBtn = document.getElementById("cancel-location");
      const yearLabel = document.getElementById("year-label");

      let currentSku = "";
      let currentLocation = "";
      let locationSaving = false;
      let statusHideTimer = null;
      const prefersReducedMotion = window.matchMedia(
        "(prefers-reduced-motion: reduce)"
      ).matches;

      yearLabel.textContent = new Date().getFullYear();

      function animateReveal(element, delayMs = 0) {
        if (!element || prefersReducedMotion) return;
        try {
          element.animate(
            [
              { opacity: 0, transform: "translateY(12px) scale(0.985)" },
              { opacity: 1, transform: "translateY(0) scale(1)" },
            ],
            {
              duration: 520,
              easing: "cubic-bezier(0.16, 1, 0.3, 1)",
              fill: "both",
              delay: delayMs,
            }
          );
        } catch {
          // no-op (older browsers)
        }
      }

      function setSkeletonState(isSkeleton) {
        locationSkeleton.hidden = !isSkeleton;
        productLocationEl.hidden = isSkeleton;
        locationPanel.hidden = false;
        resultSection.hidden = false;
        editLocationBtn.hidden = true;
        locationEditor.hidden = true;

        if (isSkeleton) {
          productCard.hidden = false;
          productVisualEl.innerHTML = '<div class="placeholder">LOADING</div>';
        }
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        lookupProduct();
      });

      input.addEventListener("input", () => {
        const { selectionStart, selectionEnd } = input;
        input.value = input.value.toUpperCase();
        input.setSelectionRange(selectionStart, selectionEnd);
      });

      editLocationBtn.addEventListener("click", () => {
        if (!locationSaving) enterLocationEdit();
      });

      cancelLocationBtn.addEventListener("click", () => {
        if (!locationSaving) cancelLocationEdit();
      });

      saveLocationBtn.addEventListener("click", () => {
        if (!locationSaving) submitLocationUpdate();
      });

      async function lookupProduct() {
        const sku = input.value.trim().toUpperCase();
        if (!sku) {
          updateStatus("Vui lòng nhập mã sản phẩm.", "error");
          return;
        }

        input.value = "";
        clearCurrentProduct();

        setSkeletonState(true);
        setLoadingState(true);
        statusBar.hidden = true;

        try {
          const product = await fetchProduct(sku);
          if (!product) {
            setSkeletonState(false);
            resultSection.hidden = true;
            updateStatus("Không tìm thấy dữ liệu cho mã " + sku, "empty");
            return;
          }
          renderProduct(sku, product);
          updateStatus("", "idle");
        } catch (error) {
          console.error(error);
          setSkeletonState(false);
          resultSection.hidden = true;
          const message =
            error.name === "AbortError"
              ? "Quá thời gian chờ. Vui lòng thử lại."
              : error.message || "Không thể lấy dữ liệu. Thử lại sau.";
          updateStatus(message, "error");
        } finally {
          setLoadingState(false);
        }
      }

      async function fetchProduct(sku) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sku }),
          signal: controller.signal,
        }).catch((error) => {
          if (error.name === "AbortError") throw error;
          throw new Error("Không thể kết nối webhook.");
        });

        clearTimeout(timeout);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(
            `Webhook trả về lỗi ${response.status}: ${errorText.substring(
              0,
              120
            )}`
          );
        }

        let payload;
        try {
          payload = await response.json();
        } catch (error) {
          const fallback = await response.text();
          throw new Error(
            "Dữ liệu webhook không hợp lệ: " + fallback.substring(0, 120)
          );
        }

        const blocks = normalizePayload(payload);
        if (!blocks.length) return null;

        const info =
          blocks.find((item) => "price" in item || "imageUrl" in item) ??
          blocks[0];
        const locationEntry =
          blocks.find((item) => "Location" in item || "location" in item) ??
          {};

        return {
          found: info?.found ?? true,
          imageUrl: info?.imageUrl || "",
          location: locationEntry.Location || locationEntry.location || "",
        };
      }

      function normalizePayload(payload) {
        const wrap = (value) => (Array.isArray(value) ? value : [value]);
        const flatten = (value) => value.flatMap((item) => {
          if (item && Array.isArray(item.data)) return item.data;
          if (item && typeof item.data === "object" && item.data !== null) {
            return [item.data];
          }
          return [item];
        });
        try {
          return flatten(wrap(payload));
        } catch {
          return [];
        }
      }

      function renderProduct(sku, product) {
        setSkeletonState(false);

        // Xóa nội dung cũ để animation mượt hơn
        productVisualEl.innerHTML = "";

        resultSection.hidden = false;
        locationPanel.hidden = false;

        currentSku = sku;
        currentLocation = product.location || "";

        updateLocationText(currentLocation);
        editLocationBtn.hidden = false;
        cancelLocationEdit();

        renderImage(product.imageUrl);

        animateReveal(locationPanel, 0);
        animateReveal(productCard, 90);
      }

      function renderImage(url) {
        productVisualEl.innerHTML = "";
        if (url) {
          productCard.hidden = false;
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Ảnh sản phẩm";
          img.loading = "lazy";
          img.addEventListener("error", () => {
            productCard.hidden = true;
          });
          productVisualEl.appendChild(img);
        } else {
          productCard.hidden = true;
        }
      }

      function updateStatus(message, variant = "idle", autoHideMs = 0) {
        clearTimeout(statusHideTimer);
        const normalizedMessage = (message ?? "").trim();
        if (!normalizedMessage) {
          statusBar.hidden = true;
          statusBar.dataset.variant = "idle";
          statusBar.textContent = "";
          return;
        }
        statusBar.hidden = false;
        statusBar.dataset.variant = variant;
        statusBar.textContent = normalizedMessage;
        if (autoHideMs > 0) {
          statusHideTimer = window.setTimeout(() => {
            updateStatus("", "idle");
          }, autoHideMs);
        }
      }

      function updateLocationText(location) {
        productLocationEl.textContent = location
          ? `${location}`
          : "Chưa có thông tin vị trí.";
      }

      function clearCurrentProduct() {
        currentSku = "";
        currentLocation = "";
        locationSkeleton.hidden = true;
        locationPanel.hidden = true;
        editLocationBtn.hidden = true;
        locationEditor.hidden = true;
        productLocationEl.hidden = false;
        locationInput.value = "";
        updateLocationText("");
        setLocationSaving(false);
      }

      function enterLocationEdit() {
        if (!currentSku) {
          updateStatus("Chưa có sản phẩm để chỉnh sửa.", "error", STATUS_AUTO_HIDE);
          return;
        }
        locationInput.value = currentLocation || "";
        locationEditor.hidden = false;
        productLocationEl.hidden = true;
        editLocationBtn.hidden = true;
        locationInput.focus();
      }

      function cancelLocationEdit() {
        locationEditor.hidden = true;
        productLocationEl.hidden = false;
        editLocationBtn.hidden = !currentSku;
        locationInput.value = "";
        setLocationSaving(false);
      }

      function setLocationSaving(isSaving) {
        locationSaving = isSaving;
        saveLocationBtn.disabled = isSaving;
        cancelLocationBtn.disabled = isSaving;
        locationInput.disabled = isSaving;
      }

      async function submitLocationUpdate() {
        if (!currentSku) {
          updateStatus("Chưa có sản phẩm để chỉnh sửa.", "error", STATUS_AUTO_HIDE);
          return;
        }
        const newLocation = locationInput.value.trim();
        if (!newLocation) {
          updateStatus("Vui lòng nhập vị trí mới.", "error", STATUS_AUTO_HIDE);
          locationInput.focus();
          return;
        }
        if (newLocation === currentLocation) {
          updateStatus("Vị trí chưa thay đổi.", "empty", STATUS_AUTO_HIDE);
          cancelLocationEdit();
          return;
        }

        setLocationSaving(true);
        updateStatus("Đang cập nhật vị trí...", "loading");

        try {
          const response = await fetch(UPDATE_LOCATION_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sku: currentSku,
              location: newLocation,
              previousLocation: currentLocation,
            }),
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Webhook trả về lỗi ${response.status}: ${errorText.substring(
                0,
                120
              )}`
            );
          }

          currentLocation = newLocation;
          updateLocationText(currentLocation);
          cancelLocationEdit();
          updateStatus("Đã cập nhật vị trí.", "success", STATUS_AUTO_HIDE);
        } catch (error) {
          console.error(error);
          updateStatus(
            error.message || "Không thể cập nhật vị trí.",
            "error"
          );
        } finally {
          setLocationSaving(false);
        }
      }

      function setLoadingState(isLoading) {
        button.disabled = isLoading;
        input.disabled = isLoading;
        topProgress.hidden = !isLoading;
        if (isLoading) {
          button.classList.add("loading");
        } else {
          button.classList.remove("loading");
          input.focus();
        }
      }
    </script>
  </body>
</html>

